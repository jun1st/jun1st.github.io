{"expireTime":9007200859243517000,"key":"transformer-remark-markdown-html-ast-fdfc1346858501161b3ee02ebacb8838-gatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-autolink-headersgatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-external-links-","val":{"type":"root","children":[{"type":"element","tagName":"h2","properties":{"id":"计算-s4-签名"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E8%AE%A1%E7%AE%97-s4-%E7%AD%BE%E5%90%8D","aria-hidden":true,"class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"计算 S4 签名","position":{"start":{"line":2,"column":4,"offset":4},"end":{"line":2,"column":12,"offset":12}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":12,"offset":12}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"想要直接在客户端上传文件到 AWS S3，需要通过计算基于 S4 的签名","position":{"start":{"line":4,"column":1,"offset":14},"end":{"line":4,"column":37,"offset":50}}}],"position":{"start":{"line":4,"column":1,"offset":14},"end":{"line":4,"column":37,"offset":50}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"AWS 的签名计算已经更新到第四版了，标准的步骤还是跟之前的版本差不多，分为 4 步：","position":{"start":{"line":6,"column":1,"offset":52},"end":{"line":6,"column":44,"offset":95}}}],"position":{"start":{"line":6,"column":1,"offset":52},"end":{"line":6,"column":44,"offset":95}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"发起一个请求","position":{"start":{"line":8,"column":5,"offset":101},"end":{"line":8,"column":11,"offset":107}}}],"position":{"start":{"line":8,"column":1,"offset":97},"end":{"line":8,"column":11,"offset":107}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"根据请求和相关的信息，计算出一个需要进行签名的字符串","position":{"start":{"line":9,"column":5,"offset":112},"end":{"line":9,"column":31,"offset":138}}}],"position":{"start":{"line":9,"column":1,"offset":108},"end":{"line":9,"column":31,"offset":138}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"根据 aws 提供的 access key 推导出一个签名用的 key，然后用这个签名的 key 给第二步中计算的字符串进行签名，计算出一个签名","position":{"start":{"line":10,"column":5,"offset":143},"end":{"line":10,"column":77,"offset":215}}}],"position":{"start":{"line":10,"column":1,"offset":139},"end":{"line":10,"column":77,"offset":215}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"把签名返回给客户端，客户端带着这个签名进行操作","position":{"start":{"line":11,"column":5,"offset":220},"end":{"line":11,"column":28,"offset":243}}}],"position":{"start":{"line":11,"column":1,"offset":216},"end":{"line":11,"column":28,"offset":243}}},{"type":"text","value":"\n"}],"position":{"start":{"line":8,"column":1,"offset":97},"end":{"line":11,"column":28,"offset":243}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html","target":"_blank","rel":"nofollow noopener noreferrer"},"children":[{"type":"text","value":"AWS\n官方的参考文档在这里","position":{"start":{"line":13,"column":2,"offset":246},"end":{"line":14,"column":11,"offset":260}}}],"position":{"start":{"line":13,"column":1,"offset":245},"end":{"line":14,"column":84,"offset":333}}}],"position":{"start":{"line":13,"column":1,"offset":245},"end":{"line":14,"column":84,"offset":333}}},{"type":"text","value":"\n"},{"type":"element","tagName":"hr","properties":{},"children":[],"position":{"start":{"line":16,"column":1,"offset":335},"end":{"line":16,"column":4,"offset":338}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"创建请求"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E5%88%9B%E5%BB%BA%E8%AF%B7%E6%B1%82","aria-hidden":true,"class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"创建请求","position":{"start":{"line":18,"column":6,"offset":345},"end":{"line":18,"column":10,"offset":349}}}],"position":{"start":{"line":18,"column":1,"offset":340},"end":{"line":18,"column":10,"offset":349}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"客户端需要提交给计算签名 Api 的数据有 3 个","position":{"start":{"line":20,"column":1,"offset":351},"end":{"line":20,"column":26,"offset":376}}}],"position":{"start":{"line":20,"column":1,"offset":351},"end":{"line":20,"column":26,"offset":376}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"需要上传的内容的 hash 值","position":{"start":{"line":22,"column":5,"offset":382},"end":{"line":22,"column":20,"offset":397}}}],"position":{"start":{"line":22,"column":1,"offset":378},"end":{"line":22,"column":20,"offset":397}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"需要上传内容的长度","position":{"start":{"line":23,"column":5,"offset":402},"end":{"line":23,"column":14,"offset":411}}}],"position":{"start":{"line":23,"column":1,"offset":398},"end":{"line":23,"column":14,"offset":411}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"上传内容的类型","position":{"start":{"line":24,"column":5,"offset":416},"end":{"line":24,"column":12,"offset":423}}}],"position":{"start":{"line":24,"column":1,"offset":412},"end":{"line":24,"column":12,"offset":423}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"其它自定义数据","position":{"start":{"line":25,"column":5,"offset":428},"end":{"line":25,"column":12,"offset":435}}}],"position":{"start":{"line":25,"column":1,"offset":424},"end":{"line":25,"column":12,"offset":435}}},{"type":"text","value":"\n"}],"position":{"start":{"line":22,"column":1,"offset":378},"end":{"line":25,"column":12,"offset":435}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"签名 API 根据客户端提供的数据，计算出一个唯一的 endpoint url， 稍后需要返回给客户端用，同时这个 endpoint url 还需要用在签名里。","position":{"start":{"line":27,"column":1,"offset":437},"end":{"line":27,"column":81,"offset":517}}}],"position":{"start":{"line":27,"column":1,"offset":437},"end":{"line":27,"column":81,"offset":517}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"计算签名"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E8%AE%A1%E7%AE%97%E7%AD%BE%E5%90%8D","aria-hidden":true,"class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"计算签名","position":{"start":{"line":29,"column":6,"offset":524},"end":{"line":29,"column":10,"offset":528}}}],"position":{"start":{"line":29,"column":1,"offset":519},"end":{"line":29,"column":10,"offset":528}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"计算 Canonicalized Header Names","position":{"start":{"line":31,"column":5,"offset":534},"end":{"line":31,"column":34,"offset":563}}}],"position":{"start":{"line":31,"column":1,"offset":530},"end":{"line":31,"column":34,"offset":563}}},{"type":"text","value":"\n"}],"position":{"start":{"line":31,"column":1,"offset":530},"end":{"line":31,"column":34,"offset":563}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://cdn-images-1.medium.com/max/1600/1*XGhOOWr2NJidO3EinTdb1g.png","alt":null},"children":[],"position":{"start":{"line":33,"column":1,"offset":565},"end":{"line":33,"column":75,"offset":639}}}],"position":{"start":{"line":33,"column":1,"offset":565},"end":{"line":33,"column":75,"offset":639}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":2},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"计算 Canonicalized Headers","position":{"start":{"line":35,"column":4,"offset":644},"end":{"line":35,"column":28,"offset":668}}}],"position":{"start":{"line":35,"column":1,"offset":641},"end":{"line":35,"column":28,"offset":668}}},{"type":"text","value":"\n"}],"position":{"start":{"line":35,"column":1,"offset":641},"end":{"line":35,"column":28,"offset":668}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://cdn-images-1.medium.com/max/2000/1*uP31LFBqE1hV3AxMyKCHKw.png","alt":null},"children":[],"position":{"start":{"line":37,"column":1,"offset":670},"end":{"line":37,"column":75,"offset":744}}}],"position":{"start":{"line":37,"column":1,"offset":670},"end":{"line":37,"column":75,"offset":744}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":3},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"计算 Canonical Request","position":{"start":{"line":39,"column":4,"offset":749},"end":{"line":39,"column":24,"offset":769}}}],"position":{"start":{"line":39,"column":1,"offset":746},"end":{"line":39,"column":24,"offset":769}}},{"type":"text","value":"\n"}],"position":{"start":{"line":39,"column":1,"offset":746},"end":{"line":39,"column":24,"offset":769}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://cdn-images-1.medium.com/max/1600/1*tM8i5zHplSHNoIPePbLzOg.png","alt":null},"children":[],"position":{"start":{"line":41,"column":1,"offset":771},"end":{"line":41,"column":75,"offset":845}}}],"position":{"start":{"line":41,"column":1,"offset":771},"end":{"line":41,"column":75,"offset":845}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":4},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"计算待签名字符串","position":{"start":{"line":43,"column":4,"offset":850},"end":{"line":43,"column":12,"offset":858}}}],"position":{"start":{"line":43,"column":1,"offset":847},"end":{"line":43,"column":12,"offset":858}}},{"type":"text","value":"\n"}],"position":{"start":{"line":43,"column":1,"offset":847},"end":{"line":43,"column":12,"offset":858}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://cdn-images-1.medium.com/max/2000/1*lf5SDGh1Cfa3X_0Q04gYiw.png","alt":null},"children":[],"position":{"start":{"line":45,"column":1,"offset":860},"end":{"line":45,"column":75,"offset":934}}}],"position":{"start":{"line":45,"column":1,"offset":860},"end":{"line":45,"column":75,"offset":934}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":5},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"计算 Signing Key","position":{"start":{"line":47,"column":4,"offset":939},"end":{"line":47,"column":18,"offset":953}}}],"position":{"start":{"line":47,"column":1,"offset":936},"end":{"line":47,"column":18,"offset":953}}},{"type":"text","value":"\n"}],"position":{"start":{"line":47,"column":1,"offset":936},"end":{"line":47,"column":18,"offset":953}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://cdn-images-1.medium.com/max/1600/1*Ms18UI2werMOaRQtNSo4dQ.png","alt":null},"children":[],"position":{"start":{"line":49,"column":1,"offset":955},"end":{"line":49,"column":75,"offset":1029}}}],"position":{"start":{"line":49,"column":1,"offset":955},"end":{"line":49,"column":75,"offset":1029}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"这里 SCHEME 就是 AWS4, TERMINATOR 是 aws4_request, serviceName 是 s3, regionName 就是 你的\nbucket 或者别的 service 所在的 region","position":{"start":{"line":51,"column":1,"offset":1031},"end":{"line":52,"column":31,"offset":1142}}}],"position":{"start":{"line":51,"column":1,"offset":1031},"end":{"line":52,"column":31,"offset":1142}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":6},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"计算 Signature","position":{"start":{"line":54,"column":4,"offset":1147},"end":{"line":54,"column":16,"offset":1159}}}],"position":{"start":{"line":54,"column":4,"offset":1147},"end":{"line":54,"column":16,"offset":1159}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"byte[] signature =\n(stringToSign, kSigning, “HmacSHA256”);","position":{"start":{"line":56,"column":4,"offset":1164},"end":{"line":57,"column":43,"offset":1225}}}],"position":{"start":{"line":56,"column":4,"offset":1164},"end":{"line":57,"column":43,"offset":1225}}},{"type":"text","value":"\n"}],"position":{"start":{"line":54,"column":1,"offset":1144},"end":{"line":57,"column":43,"offset":1225}}},{"type":"text","value":"\n"}],"position":{"start":{"line":54,"column":1,"offset":1144},"end":{"line":57,"column":43,"offset":1225}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"最后，拼成完成的 authorization header 返回：","position":{"start":{"line":59,"column":1,"offset":1227},"end":{"line":59,"column":34,"offset":1260}}}],"position":{"start":{"line":59,"column":1,"offset":1227},"end":{"line":59,"column":34,"offset":1260}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://cdn-images-1.medium.com/max/1600/1*wclU8vz3mMJrCRbBQRk4Ng.png","alt":null},"children":[],"position":{"start":{"line":61,"column":1,"offset":1262},"end":{"line":61,"column":75,"offset":1336}}}],"position":{"start":{"line":61,"column":1,"offset":1262},"end":{"line":61,"column":75,"offset":1336}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"authorizationHeader 就是最后的结果～","position":{"start":{"line":63,"column":1,"offset":1338},"end":{"line":63,"column":29,"offset":1366}}}],"position":{"start":{"line":63,"column":1,"offset":1338},"end":{"line":63,"column":29,"offset":1366}}},{"type":"text","value":"\n"},{"type":"element","tagName":"hr","properties":{},"children":[],"position":{"start":{"line":65,"column":1,"offset":1368},"end":{"line":65,"column":4,"offset":1371}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"客户端调用"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8","aria-hidden":true,"class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"客户端调用","position":{"start":{"line":67,"column":6,"offset":1378},"end":{"line":67,"column":11,"offset":1383}}}],"position":{"start":{"line":67,"column":1,"offset":1373},"end":{"line":67,"column":11,"offset":1383}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"最后在客户端调用的时候，需要使用在计算签名时返回的 url 作为 endpoint， 并且，签名时所使用到的 header 一个都不能少","position":{"start":{"line":69,"column":1,"offset":1385},"end":{"line":69,"column":69,"offset":1453}}}],"position":{"start":{"line":69,"column":1,"offset":1385},"end":{"line":69,"column":69,"offset":1453}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"所有用到的代码都在这里：\n","position":{"start":{"line":71,"column":1,"offset":1455},"end":{"line":72,"column":1,"offset":1468}}},{"type":"element","tagName":"a","properties":{"href":"https://gist.github.com/jun1st/b5b1f0b0bac37e30f279659a6f091fca","target":"_blank","rel":"nofollow noopener noreferrer"},"children":[{"type":"text","value":"gists","position":{"start":{"line":72,"column":2,"offset":1469},"end":{"line":72,"column":7,"offset":1474}}}],"position":{"start":{"line":72,"column":1,"offset":1468},"end":{"line":72,"column":73,"offset":1540}}}],"position":{"start":{"line":71,"column":1,"offset":1455},"end":{"line":72,"column":73,"offset":1540}}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":72,"column":73,"offset":1540}}}}