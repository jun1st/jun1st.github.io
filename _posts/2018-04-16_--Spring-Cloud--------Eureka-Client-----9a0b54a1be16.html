<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>使用Spring Cloud构建微服务之三 Eureka Client之间互通</title><meta name="description" content="上一篇 注册了一个简单的Servcie，这一篇讲一下使用 RestTemplate 来调用注册在 Eureka 上的服务。"><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">使用Spring Cloud构建微服务之三 Eureka Client之间互通</h1>
</header>
<section data-field="subtitle" class="p-summary">
上一篇 注册了一个简单的Servcie，这一篇讲一下使用 RestTemplate 来调用注册在 Eureka 上的服务。
</section>
<section data-field="body" class="e-content">
<section name="4698" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5f2e" id="5f2e" class="graf graf--h3 graf--leading graf--title">使用Spring Cloud构建微服务之三 Eureka Client之间互通</h3><p name="5888" id="5888" class="graf graf--p graf-after--h3"><a href="https://medium.com/@fengqijun/%E4%BD%BF%E7%94%A8-spring-cloud-%E6%9E%84%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E4%BA%8C-eureka-client-acd6022f94df" data-href="https://medium.com/@fengqijun/%E4%BD%BF%E7%94%A8-spring-cloud-%E6%9E%84%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E4%BA%8C-eureka-client-acd6022f94df" class="markup--anchor markup--p-anchor" target="_blank">上一</a>篇 注册了一个简单的Servcie，这一篇讲一下使用 RestTemplate 来调用注册在 Eureka 上的服务。</p><p name="aa10" id="aa10" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Service Provider</strong></p><p name="a589" id="a589" class="graf graf--p graf-after--p">先给 Service Provider 写一个简单的返回一个 Json 对象的Api，Greeting</p><pre name="34e4" id="34e4" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">import </strong>lombok.Data;<br><strong class="markup--strong markup--pre-strong">import </strong>lombok.experimental.Accessors;<br><br>@Data<br>@Accessors(chain = <strong class="markup--strong markup--pre-strong">true</strong>)<br><strong class="markup--strong markup--pre-strong">public class </strong>Greeting {<br>    <strong class="markup--strong markup--pre-strong">private </strong>String <strong class="markup--strong markup--pre-strong">name</strong>, <strong class="markup--strong markup--pre-strong">message</strong>;<br>}</pre><p name="0f2a" id="0f2a" class="graf graf--p graf-after--pre">Root Api直接返回一个 Greeting 对象</p><pre name="224d" id="224d" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">import </strong>org.springframework.web.bind.annotation.GetMapping;<br><strong class="markup--strong markup--pre-strong">import </strong>org.springframework.web.bind.annotation.RestController;<br><br>@RestController<br><strong class="markup--strong markup--pre-strong">public class </strong>HomeController {<br><br>    @GetMapping(<strong class="markup--strong markup--pre-strong">&quot;&quot;</strong>)<br>    <strong class="markup--strong markup--pre-strong">public </strong>Greeting index() {<br>        Greeting greeting = <strong class="markup--strong markup--pre-strong">new </strong>Greeting();<br>        greeting.setName(<strong class="markup--strong markup--pre-strong">&quot;Jon&quot;</strong>)<br>                .setMessage(<strong class="markup--strong markup--pre-strong">&quot;How are you&quot;</strong>);<br><br>        <strong class="markup--strong markup--pre-strong">return </strong>greeting;<br>    }<br><br>}</pre><p name="2994" id="2994" class="graf graf--p graf-after--pre">结果：</p><figure name="fc0f" id="fc0f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 688px; max-height: 288px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 41.9%;"></div><img class="graf-image" data-image-id="1*VFC-nfRVnVVhvBZ_wMzTvA.png" data-width="688" data-height="288" src="https://cdn-images-1.medium.com/max/800/1*VFC-nfRVnVVhvBZ_wMzTvA.png"></div></figure><p name="d17d" id="d17d" class="graf graf--p graf-after--figure">微服务提供方已经Ready。</p><p name="897a" id="897a" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Service Consumer</strong></p><p name="5fde" id="5fde" class="graf graf--p graf-after--p">同样也是一个Spring Boot 应用，同时也是 Eureka 的一个Client。作为调用方，她是一个使用者。至于是否作为一个服务提供者，可以自由选择。</p><p name="9418" id="9418" class="graf graf--p graf-after--p">同样是通过 <code class="markup--code markup--p-code">application.properties</code> 配置 eureka 属性</p><pre name="b6f6" id="b6f6" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">server.port</strong>=<strong class="markup--strong markup--pre-strong">8002<br><br>spring.application.name</strong>=<strong class="markup--strong markup--pre-strong">service-consumer<br><br>eureka.client.register-with-eureka</strong>=<strong class="markup--strong markup--pre-strong">true<br>eureka.client.enabled</strong>=<strong class="markup--strong markup--pre-strong">true<br>eureka.client.serviceUrl.defaultZone</strong>=<strong class="markup--strong markup--pre-strong">http://localhost:8000/eureka<br>eureka.instance.prefer-ip-address</strong>=<strong class="markup--strong markup--pre-strong">true</strong></pre><p name="c94b" id="c94b" class="graf graf--p graf-after--pre">这里设置 <code class="markup--code markup--p-code">register-with-eureka</code> 为 <code class="markup--code markup--p-code">true</code>，就会把 service-consumer 也注册为一个服务提供方。</p><figure name="a54a" id="a54a" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 249px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 35.5%;"></div><img class="graf-image" data-image-id="1*dEKBzhYAcTZY4e-INBBVfg.png" data-width="2382" data-height="846" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*dEKBzhYAcTZY4e-INBBVfg.png"></div></figure><p name="4ec4" id="4ec4" class="graf graf--p graf-after--figure">可以看到 Service Consumer 也注册进 Eureka 了。</p><p name="2432" id="2432" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Eureka Services 之间如何通讯</strong></p><p name="7e13" id="7e13" class="graf graf--p graf-after--p">有一个说法说CS有两个难题，一个是变量命名，另一个是 <code class="markup--code markup--p-code">Cache Invalidation</code>。 还有一个说话是，CS 中的问题，没有一个是不能通过加一层来解决了。这个 Eureka Server 就相当于是中间加的一层。</p><p name="10fe" id="10fe" class="graf graf--p graf-after--p">Consumer 调用 Provider</p><pre name="25ab" id="25ab" class="graf graf--pre graf-after--p">@RestController<br><strong class="markup--strong markup--pre-strong">public class </strong>HomeController {<br><br>    @Autowired<br>    <strong class="markup--strong markup--pre-strong">private </strong>RestTemplate <strong class="markup--strong markup--pre-strong">restTemplate</strong>;<br><br>    @GetMapping(<strong class="markup--strong markup--pre-strong">&quot;/&quot;</strong>)<br>    <strong class="markup--strong markup--pre-strong">public </strong>String echo() {<br>        <strong class="markup--strong markup--pre-strong">return &quot;hello&quot;</strong>;<br>    }<br><br>    @GetMapping(<strong class="markup--strong markup--pre-strong">&quot;/call-provider&quot;</strong>)<br>    <strong class="markup--strong markup--pre-strong">public </strong>Object call() {<br>        Object result = <strong class="markup--strong markup--pre-strong">restTemplate</strong>.getForObject(<strong class="markup--strong markup--pre-strong">&quot;http://SERVICE-PROVIDER&quot;</strong>, Object.<strong class="markup--strong markup--pre-strong">class</strong>);<br>        <strong class="markup--strong markup--pre-strong">return </strong>result;<br>    }<br><br><br>    @Bean<br>    @LoadBalanced<br>    <strong class="markup--strong markup--pre-strong">public </strong>RestTemplate restTemplate() {<br>        <strong class="markup--strong markup--pre-strong">return new </strong>RestTemplateBuilder().build();<br>    }<br><br>}</pre><p name="794b" id="794b" class="graf graf--p graf-after--pre">这里个 <code class="markup--code markup--p-code">Consumer</code> 添加了一个 <code class="markup--code markup--p-code">/call-provider</code> 方法，在方法内，通过 RestTemplate，调用了 provider 的Api。 这里并没有使用 Url 地址或者 IP 地址，而是使用了注册在 Eureka Server 上的 application name，并且成功的得到了返回结果。</p><figure name="ea2e" id="ea2e" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 255px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 36.4%;"></div><img class="graf-image" data-image-id="1*nccW1e6i5v2pr0q1b4Dk7Q.png" data-width="726" data-height="264" src="https://cdn-images-1.medium.com/max/800/1*nccW1e6i5v2pr0q1b4Dk7Q.png"></div></figure><p name="1de5" id="1de5" class="graf graf--p graf-after--figure"><code class="markup--code markup--p-code">RestTemplate</code> 的 <code class="markup--code markup--p-code">LoadBalanced</code> 注解来自 Spring Cloud 的 Ribbon 依赖。 Ribbon是用来干什么的？ 下篇再见～</p><p name="3cc7" id="3cc7" class="graf graf--p graf-after--p graf--trailing"><a href="https://github.com/jun1st/service-consumer" data-href="https://github.com/jun1st/service-consumer" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">源代码地址</a></p></div></div></section>
</section>
<footer><p class="p-tags">Tagged in <a href="https://medium.com/tag/spring-cloud" class="p-tag">Spring Cloud</a>, <a href="https://medium.com/tag/spring" class="p-tag">Spring</a>, <a href="https://medium.com/tag/eureka" class="p-tag">Eureka</a>, <a href="https://medium.com/tag/ribbon" class="p-tag">Ribbon</a>, <a href="https://medium.com/tag/resttemplate" class="p-tag">Resttemplate</a></p><p>By <a href="https://medium.com/@fengqijun" class="p-author h-card">feng qijun</a> on <a href="https://medium.com/p/9a0b54a1be16"><time class="dt-published" datetime="2018-04-16T15:18:14.147Z">April 16, 2018</time></a>.</p><p><a href="https://medium.com/@fengqijun/%E4%BD%BF%E7%94%A8spring-cloud%E6%9E%84%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E4%B8%89-eureka-client%E4%B9%8B%E9%97%B4%E4%BA%92%E9%80%9A-9a0b54a1be16" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 17, 2018.</p></footer></article>

</body></html>